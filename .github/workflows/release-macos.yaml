name: Release macOS (DMG + Sparkle + R2 + Pages)

on:
  release:
    types: [ published ]

permissions:
  contents: read

concurrency:
  group: release-macos-${{github.event.release.tag_name}}
  cancel-in-progress: false

jobs:
  macos-release:
    environment: production
    runs-on: macos-latest
    if: github.actor != 'github-actions[bot]'

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install FlutterFire CLI
        run: |
          dart pub global activate flutterfire_cli

      # --- NEW: Cache Flutter Dependencies ---
      - name: Cache Pub Packages
        uses: actions/cache@v5.0.3
        with:
          path: |
            ${{ env.PUB_CACHE }}
            ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      # --- NEW: Cache CocoaPods ---
      - name: Cache CocoaPods
        uses: actions/cache@v5.0.3
        with:
          path: macos/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('macos/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Resolve version
        id: ver
        shell: bash
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "dmg=LucidClip-v${VERSION}.dmg" >> $GITHUB_OUTPUT

      #      # --- FIX: Update Deployment Target to 10.15 ---
      #      - name: Update macOS Deployment Target
      #        run: |
      #          sed -i '' "s/platform :osx, '10.11'/platform :osx, '10.15'/g" macos/Podfile
      #          # Uncomment below if the line is commented out in your Podfile:
      #          # sed -i '' "s/# platform :osx, '10.11'/platform :osx, '10.15'/g" macos/Podfile

      - name: Disable Code Signing (Hard Remove)
        run: |
          pbx="macos/Runner.xcodeproj/project.pbxproj"
          
          # 1. Wipe the signing identity (replaces "Developer ID Application" with empty string)
          sed -i '' 's/CODE_SIGN_IDENTITY = .*/CODE_SIGN_IDENTITY = "";/g' $pbx
          sed -i '' 's/"CODE_SIGN_IDENTITY\[sdk=macosx\*\]" = .*/"CODE_SIGN_IDENTITY[sdk=macosx*]" = "";/g' $pbx
          
          # 2. Wipe the Development Team (replaces your Team ID with empty string)
          sed -i '' 's/DEVELOPMENT_TEAM = .*/DEVELOPMENT_TEAM = "";/g' $pbx
          
          # 3. Wipe the Provisioning Profile Specifier
          sed -i '' 's/PROVISIONING_PROFILE_SPECIFIER = .*/PROVISIONING_PROFILE_SPECIFIER = "";/g' $pbx
          
          # 4. Force Manual Signing AND inject the "Disable Signing" flags into the same line
          # This ensures CODE_SIGNING_REQUIRED=NO is actually present inside the buildSettings block
          sed -i '' 's/CODE_SIGN_STYLE = .*/CODE_SIGN_STYLE = Manual; CODE_SIGNING_REQUIRED = NO; CODE_SIGNING_ALLOWED = NO;/g' $pbx

      - name: Build macOS (production)
        shell: bash
        run: |
          cat > env.json << 'JSON'
          ${{secrets.DART_DEFINES_JSON}}
          JSON
          flutter --version
          flutter pub get
          flutter build macos --flavor production -t lib/main_production.dart --dart-define-from-file=env.json

      # ---------- Import Developer ID cert ----------
      - name: Import Developer ID certificate
        shell: bash
        env:
          P12_B64: ${{ secrets.MACOS_CERT_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo "$P12_B64" | base64 --decode > cert.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import cert.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" build.keychain

      # ---------- Sign .app ----------
      - name: Codesign .app
        shell: bash
        run: |
          ENTITLEMENTS="macos/Runner/Release.entitlements"
          APP="build/macos/Build/Products/Release-production/LucidClip.app"
          codesign --deep --force --options runtime --entitlements "$ENTITLEMENTS" --sign "Developer ID Application" "$APP"
          codesign --verify --deep --strict --verbose=2 "$APP"
      

      # 1. Zippage (Requis pour l'envoi au service de notarisation)
      - name: Zip .app for Notarization
        shell: bash
        run: |
          APP_PATH="build/macos/Build/Products/Release-production/LucidClip.app"
          ZIP_PATH="build/macos/Build/Products/Release-production/LucidClip.zip"
          
          ditto -c -k --keepParent "$APP_PATH" "$ZIP_PATH"

      - name: Notarize .app
        shell: bash
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASS: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          ZIP_PATH="build/macos/Build/Products/Release-production/LucidClip.zip"
          
          xcrun notarytool submit "$ZIP_PATH" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASS" \
            --team-id "$TEAM_ID" \
            --wait

      - name: Staple .app
        shell: bash
        run: |
          APP_PATH="build/macos/Build/Products/Release-production/LucidClip.app"
          
          xcrun stapler staple "$APP_PATH"
      

      # ---------- Create DMG ----------

      - name: Install create-dmg
        run: brew install create-dmg

      - name: Create DMG (Drag to Applications)
        shell: bash
        run: |
          APP="build/macos/Build/Products/Release-production/LucidClip.app"
          APP_NAME="LucidClip"
          VERSION="${{ steps.ver.outputs.version }}"
          DMG="${{ steps.ver.outputs.dmg }}"
          
          cp assets/installer/macos/dmg_background.tiff dmg_background.tiff
          cp assets/installer/macos/logo.icns logo.icns
          
          rm -f "$DMG"
          
          create-dmg \
            --background dmg_background.tiff \
            --volname "${APP_NAME}" \
            --volicon logo.icns \
            --window-size 800 500 \
            --window-pos 200 120 \
            --icon-size 128 \
            --icon "${APP_NAME}.app" 170 250 \
            --app-drop-link 580 250 \
            --hide-extension "${APP_NAME}.app" \
            --hide-extension "Applications" \
            --no-internet-enable \
            --hdiutil-quiet \
            "$DMG" \
            "$APP"
          
          ls -lh "$DMG"

      # ---------- Notarize + Staple ----------
      - name: Notarize DMG
        shell: bash
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASS: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          DMG="${{ steps.ver.outputs.dmg }}"
          xcrun notarytool submit "$DMG" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASS" \
            --team-id "$TEAM_ID" \
            --wait

      - name: Staple + validate
        shell: bash
        run: |
          DMG="${{ steps.ver.outputs.dmg }}"
          xcrun stapler staple "$DMG"
          xcrun stapler validate "$DMG"

      # ---------- Sparkle tools ----------
      - name: Download Sparkle (CLI tools)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          # 1. Get the download URL for the latest 'Sparkle-VERSION.tar.xz'
          DOWNLOAD_URL=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/sparkle-project/Sparkle/releases/latest | \
            jq -r '.assets[] | select(.name | test("Sparkle-[0-9.]+\\.tar\\.xz$")) | .browser_download_url')
          
          echo "Downloading from: $DOWNLOAD_URL"
          
          # 2. Download the file
          curl -L -o sparkle.tar.xz "$DOWNLOAD_URL"
          
          # 3. Create directory and extract (use tar for .xz files)
          mkdir -p sparkle
          tar -xf sparkle.tar.xz -C sparkle
          
          # 4. Verify the binary exists
          ls -la sparkle/bin/generate_appcast

      - name: Restore Sparkle private key (file)
        shell: bash
        env:
          SPARKLE_PRIV_B64: ${{ secrets.SPARKLE_PRIV_KEY_BASE64 }}
        run: |
          echo "$SPARKLE_PRIV_B64" | base64 --decode > sparkle_ed25519.priv
          chmod 600 sparkle_ed25519.priv
          ls -lh sparkle_ed25519.priv

      # ---------- Generate appcast ----------
      - name: Generate appcast.xml
        shell: bash
        run: |
          mkdir -p updates/macos
          cp "${{ steps.ver.outputs.dmg }}" "updates/macos/${{ steps.ver.outputs.dmg }}"

          SPARKLE_BIN="$(find sparkle -name generate_appcast | head -n 1 | xargs dirname)"

          "$SPARKLE_BIN/generate_appcast" \
            --ed-key-file sparkle_ed25519.priv \
            --download-url-prefix "https://downloads.lucidclip.app/macos/" \
            updates/macos

          # Sanity check
          grep -q "sparkle:edSignature" updates/macos/appcast.xml

      # ---------- Upload DMG to R2 ----------
      - name: Upload DMG to R2 (Cloudflare)
        shell: bash
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          R2_BUCKET: ${{ vars.R2_BUCKET }}
        run: |
          npm i -g wrangler
          wrangler r2 object put --remote "${R2_BUCKET}/macos/${{ steps.ver.outputs.dmg }}" \
            --file "${{ steps.ver.outputs.dmg }}"
          
          wrangler r2 object put --remote "${R2_BUCKET}/macos/LucidClip-latest.dmg" \
            --file "${{ steps.ver.outputs.dmg }}"

      # ---------- Deploy appcast to Pages ----------
      - name: Deploy appcast.xml to Pages
        shell: bash
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PAGES_PROJECT: ${{ vars.PAGES_PROJECT }}
        run: |
          npm i -g wrangler
          mkdir -p pages_out/macos
          cp updates/macos/appcast.xml pages_out/macos/appcast.xml
          
          wrangler pages deploy pages_out \
            --project-name="$PAGES_PROJECT" \
            --branch=master \
            --commit-dirty=true \
            --commit-message="Deploy macOS appcast for ${{ github.event.release.tag_name }}"